using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp.Syntax;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace Asaki.CodeGen.Generators
{
    public static class AsakiInjectGenerator
    {
        public static void Execute(GeneratorExecutionContext context, List<MethodDeclarationSyntax> candidates)
        {
            if (candidates == null || candidates.Count == 0) return;

            var compilation = context.Compilation;
            var attributeSymbol = compilation.GetTypeByMetadataName("Asaki.Core.Attributes.AsakiInjectAttribute");
            if (attributeSymbol == null) return;

            // 筛选有效方法
            var validMethods = new List<(MethodDeclarationSyntax Syntax, IMethodSymbol Symbol)>();
            foreach (var methodDeclaration in candidates)
            {
                var model = compilation.GetSemanticModel(methodDeclaration.SyntaxTree);
                var methodSymbol = model.GetDeclaredSymbol(methodDeclaration) as IMethodSymbol;
                if (methodSymbol == null) continue;

                if (methodSymbol.GetAttributes().Any(ad => SymbolEqualityComparer.Default.Equals(ad.AttributeClass, attributeSymbol)))
                {
                    validMethods.Add((methodDeclaration, methodSymbol));
                }
            }

            if (validMethods.Count == 0) return;

            // 开始生成
            string assemblyNameSafe = context.Compilation.AssemblyName.Replace(".", "_").Replace("-", "_");
            string className = $"AsakiAssemblyInjector_{assemblyNameSafe}";
            var sb = new StringBuilder();

            sb.AppendLine("// <auto-generated/>");
            sb.AppendLine("using Asaki.Core.Context;");
            sb.AppendLine("using UnityEngine;");
            sb.AppendLine("using System;");
            sb.AppendLine();
            sb.AppendLine("namespace Asaki.Generated.Injectors");
            sb.AppendLine("{");
            sb.AppendLine($"    /// <summary> 程序集专用注入器: {context.Compilation.AssemblyName} </summary>");
            sb.AppendLine($"    public class {className} : IAsakiInjector");
            sb.AppendLine("    {");
            
            // AutoRegister
            sb.AppendLine("        [RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.SubsystemRegistration)]");
            sb.AppendLine("        private static void AutoRegister()");
            sb.AppendLine("        {");
            sb.AppendLine($"            global::Asaki.Unity.Bootstrapper.AsakiGlobalInjector.Register(new {className}());");
            sb.AppendLine("        }");
            sb.AppendLine();

            // 1. 接口实现 (Instance Method)
            sb.AppendLine("        /// <summary> [Interface] 接口实现，转发给静态逻辑 </summary>");
            sb.AppendLine("        public void Inject(object target, global::Asaki.Core.Context.IAsakiResolver resolver = null)");
            sb.AppendLine("        {");
            sb.AppendLine("            InjectInternal(target, resolver);"); 
            sb.AppendLine("        }");
            sb.AppendLine();

            // 2. 静态实现 (Static Method) - 改名为 InjectInternal
            sb.AppendLine($"        public static void InjectInternal(object module, global::Asaki.Core.Context.IAsakiResolver resolver = null)");
            sb.AppendLine("        {");
            sb.AppendLine("            if (module == null) return;");
            sb.AppendLine("            if (resolver == null) resolver = global::Asaki.Core.Context.Resolvers.AsakiGlobalResolver.Instance;");
            sb.AppendLine();

            // 生成注入逻辑
            foreach (var pair in validMethods)
            {
                var methodSymbol = pair.Symbol;
                var classSymbol = methodSymbol.ContainingType;

                string fullClassName = classSymbol.ToDisplayString(SymbolDisplayFormat.FullyQualifiedFormat);
                string methodName = methodSymbol.Name;
                
                // [Fix] 生成合法的变量名 (移除 . 和 ::)
                // 例如: global::Asaki.UI -> target_Asaki_UI_HexCode
                string safeVarName = $"target_{classSymbol.Name}_{classSymbol.GetHashCode().ToString("X").Replace("-", "_")}"; 

                sb.AppendLine($"            if (module is {fullClassName} {safeVarName})");
                sb.AppendLine("            {");
                sb.Append($"                {safeVarName}.{methodName}(");

                var parameters = methodSymbol.Parameters;
                for (int i = 0; i < parameters.Length; i++)
                {
                    var paramType = parameters[i].Type;
                    string fullParamTypeName = paramType.ToDisplayString(SymbolDisplayFormat.FullyQualifiedFormat);

                    sb.Append($"resolver.Get<{fullParamTypeName}>()");

                    if (i < parameters.Length - 1) sb.Append(", ");
                }

                sb.AppendLine(");");
                sb.AppendLine("                return;");
                sb.AppendLine("            }");
            }

            sb.AppendLine("        }"); // End Static
            sb.AppendLine("    }");     // End Class
            sb.AppendLine("}");         // End Namespace

            context.AddSource($"{className}.g.cs", sb.ToString());
        }
    }
}
