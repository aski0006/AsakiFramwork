using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp.Syntax;
using System.Collections.Generic;
using System.Globalization;
using System.Text;

public static class BrokerGenerator
{
    // [Fix] 使用 global:: 前缀确保绝对路径
    private const string EVENT_INTERFACE_NAMESPACE = "Asaki.Core.Broker";
    private const string BROKER_FULL_NAME = "global::Asaki.Core.Broker.AsakiBroker"; 

    public static void Execute(GeneratorExecutionContext context, List<ClassDeclarationSyntax> candidates)
    {
        var sb = new StringBuilder();
        sb.AppendLine("// <auto-generated/>");
        sb.AppendLine("// 生成时间: " + System.DateTime.Now.ToString(CultureInfo.InvariantCulture));
        sb.AppendLine("using System;");
        // [Fix] 移除这些 using，改为在代码中使用全名，避免命名空间污染或歧义
        // sb.AppendLine("using Asaki.Core.Broker;"); 
        // sb.AppendLine("using Asaki.Core.Context;");
        sb.AppendLine();
        sb.AppendLine("namespace Asaki.Generated");
        sb.AppendLine("{");
        sb.AppendLine("    internal static class AsakiBrokerExtensions");
        sb.AppendLine("    {");

        // 1. Generate AsakiRegister
        sb.AppendLine("        internal static void AsakiRegister(this object obj)");
        sb.AppendLine("        {");
        
        if (candidates.Count == 0)
        {
            sb.AppendLine("            // No event handlers found during code generation");
        }
        else
        {
            GenerateBody(context, candidates, sb, "Subscribe");
        }
        
        sb.AppendLine("        }");
        sb.AppendLine();

        // 2. Generate AsakiUnregister
        sb.AppendLine("        internal static void AsakiUnregister(this object obj)");
        sb.AppendLine("        {");
        
        if (candidates.Count == 0)
        {
            sb.AppendLine("            // No event handlers found during code generation");
        }
        else
        {
            GenerateBody(context, candidates, sb, "Unsubscribe");
        }
        
        sb.AppendLine("        }");
        sb.AppendLine("    }");
        sb.AppendLine("}");

        context.AddSource("AsakiBrokerExtensions.g.cs", sb.ToString());
    }

    private static void GenerateBody(GeneratorExecutionContext context, List<ClassDeclarationSyntax> candidates, StringBuilder sb, string methodName)
    {
        var format = new SymbolDisplayFormat(
            typeQualificationStyle: SymbolDisplayTypeQualificationStyle.NameAndContainingTypesAndNamespaces,
            genericsOptions: SymbolDisplayGenericsOptions.IncludeTypeParameters,
            globalNamespaceStyle: SymbolDisplayGlobalNamespaceStyle.Included // [Fix] 强制 Symbol 输出 global::
        );

        var processedSymbols = new HashSet<string>();

        foreach (var syntax in candidates)
        {
            var model = context.Compilation.GetSemanticModel(syntax.SyntaxTree);
            var symbol = model.GetDeclaredSymbol(syntax) as INamedTypeSymbol;
            if (symbol == null) continue;

            var allInterfaces = symbol.AllInterfaces;
            var handlerInterfaces = new List<INamedTypeSymbol>();

            foreach (var i in allInterfaces)
            {
                // 检查接口是否是 IAsakiHandler
                if (i.Name == "IAsakiHandler" && i.IsGenericType)
                {
                    // 检查命名空间是否匹配
                    var ns = i.ContainingNamespace.ToDisplayString();
                    if (ns == EVENT_INTERFACE_NAMESPACE)
                    {
                        handlerInterfaces.Add(i);
                    }
                }
            }

            if (handlerInterfaces.Count > 0)
            {
                // 使用 global:: 前缀的全名
                var typeName = symbol.ToDisplayString(format); 
                
                if (processedSymbols.Contains(typeName)) continue;
                processedSymbols.Add(typeName);

                sb.AppendLine($"            // Handler: {symbol.Name}");
                sb.AppendLine($"            if (obj is {typeName} handler_{symbol.Name})");
                sb.AppendLine("            {");

                foreach (var handler in handlerInterfaces)
                {
                    // eventType 也会包含 global:: 前缀
                    var eventType = handler.TypeArguments[0].ToDisplayString(format);
                    
                    // 生成调用代码: global::Asaki.Core.Broker.AsakiBroker.Subscribe<...>(...)
                    sb.AppendLine($"                {BROKER_FULL_NAME}.{methodName}<{eventType}>(handler_{symbol.Name});");
                }

                sb.AppendLine("                return;");
                sb.AppendLine("            }");
            }
        }
    }
}