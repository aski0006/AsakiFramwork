using System.Collections.Generic;
using System.Linq;
using System.Text;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp.Syntax;

namespace Asaki.CodeGen.Generators
{
    public static class GraphRegistryGenerator
    {
        public static void Execute(GeneratorExecutionContext context, List<ClassDeclarationSyntax> candidates)
        {
            if (candidates.Count == 0) return;

            StringBuilder sb = new StringBuilder();

            // 1. 文件头
            sb.AppendLine("// <auto-generated> Asaki Graph Registry </auto-generated>");
            sb.AppendLine("using UnityEditor;");
            sb.AppendLine("using Asaki.Editor.GraphEditors;");
            sb.AppendLine("using Asaki.Core.Graphs;");
            sb.AppendLine("using Asaki.Core;");
            sb.AppendLine("");

            // 2. 生成一个标记为 InitializeOnLoad 的类
            // 这确保了 Unity 编辑器启动或编译完成后，构造函数会自动运行
            sb.AppendLine("namespace Asaki.Generated");
            sb.AppendLine("{");
            sb.AppendLine("    [InitializeOnLoad]");
            sb.AppendLine("    public static class AsakiGraphRegistry_Gen");
            sb.AppendLine("    {");
            sb.AppendLine("        static AsakiGraphRegistry_Gen()");
            sb.AppendLine("        {");

            foreach (var controllerClass in candidates)
            {
                var semanticModel = context.Compilation.GetSemanticModel(controllerClass.SyntaxTree);
                var controllerSymbol = semanticModel.GetDeclaredSymbol(controllerClass);

                // 获取 CustomGraphEditor 特性
                var attr = controllerSymbol.GetAttributes()
                    .FirstOrDefault(a => a.AttributeClass.Name.Contains("CustomGraphEditor"));

                if (attr != null && attr.ConstructorArguments.Length > 0)
                {
                    // 获取特性里的参数 (即 GraphType)
                    var graphTypeSymbol = attr.ConstructorArguments[0].Value as INamedTypeSymbol;
                    
                    if (graphTypeSymbol != null)
                    {
                        string graphTypeName = graphTypeSymbol.ToDisplayString();
                        string controllerTypeName = controllerSymbol.ToDisplayString();

                        // 生成注册代码：
                        // AsakiGraphWindow.Register<MyDemoGraph>(asset => new MyController(asset));
                        sb.AppendLine($"            AsakiGraphWindow.Register<{graphTypeName}>(asset => new {controllerTypeName}(asset));");
                    }
                }
            }

            sb.AppendLine("        }");
            sb.AppendLine("    }");
            sb.AppendLine("}");

            // 3. 输出文件
            context.AddSource("AsakiGraphRegistry_Gen.cs", sb.ToString());
        }
    }
}