using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp.Syntax;
using System.Collections.Generic;
using System.Text;
using System.Linq;

namespace Asaki.CodeGen.Generators
{
    public static class ModuleRegistryGenerator
    {
        public static void Execute(GeneratorExecutionContext context, List<ClassDeclarationSyntax> candidates)
        {
            if (candidates.Count == 0) return;

            // 为了避免不同 Assembly 生成的类名冲突，我们使用 AssemblyName 作为后缀
            // 例如: AsakiGeneratedModuleRegistry_Asaki_Unity
            if (context.Compilation.AssemblyName != null)
            {
                string assemblyName = context.Compilation.AssemblyName.Replace(".", "_").Replace("-", "_");
                string className = $"AsakiModuleRegistry_{assemblyName}";

                var sb = new StringBuilder();
                sb.AppendLine("// <auto-generated/>");
                sb.AppendLine("using UnityEngine;");
                sb.AppendLine("using Asaki.Unity.Bootstrapper;");
                sb.AppendLine("using System;");
                sb.AppendLine();
                sb.AppendLine("namespace Asaki.Generated");
                sb.AppendLine("{");
                sb.AppendLine($"    // Auto-registered modules for assembly: {context.Compilation.AssemblyName}");
                sb.AppendLine($"    internal static class {className}");
                sb.AppendLine("    {");
            
                // 使用 SubsystemRegistration 确保在所有 MonoBehaviour Awake 之前执行
                // 这比 DefaultExecutionOrder(-9999) 还要早
                sb.AppendLine("        [RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.SubsystemRegistration)]");
                sb.AppendLine("        private static void RegisterModules()");
                sb.AppendLine("        {");

                foreach (var syntax in candidates)
                {
                    var model = context.Compilation.GetSemanticModel(syntax.SyntaxTree);
                    var symbol = model.GetDeclaredSymbol(syntax) as INamedTypeSymbol;
                
                    if (symbol == null) continue;
                
                    // 确保实现了 IAsakiModule 且非抽象
                    if (symbol.IsAbstract) continue;

                    // 使用 global:: 全名防止命名冲突
                    string fullTypeName = symbol.ToDisplayString(SymbolDisplayFormat.FullyQualifiedFormat);

                    // 生成注册调用
                    sb.AppendLine($"            AsakiStaticModuleDiscovery.Register(typeof({fullTypeName}));");
                }

                sb.AppendLine("        }");
                sb.AppendLine("    }");
                sb.AppendLine("}");

                context.AddSource($"{className}.g.cs", sb.ToString());
            }
        }
    }
}